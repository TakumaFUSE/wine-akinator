<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wine Personaï½œå‡¦æ–¹ç®‹UI Mock</title>
  <style>
    :root{
      --bg: #fbfbfd;
      --card-bg: #ffffff;
      --bg-soft: #f4f5f7;
      --border: #e6e8ee;
      --text: #111827;
      --muted: #6b7280;
      --accent: #7c3aed;
      --shadow: 0 14px 44px rgba(17,24,39,.06);
      --radius: 24px;

      --font-sans: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Segoe UI", Arial;
      --font-serif: ui-serif, "Iowan Old Style", "Palatino", "Hiragino Mincho ProN", "Noto Serif JP", serif;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--font-sans);
      color: var(--text);
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(124,58,237,.06), transparent 60%),
        radial-gradient(900px 520px at 80% 20%, rgba(6,182,212,.05), transparent 60%),
        var(--bg);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:20px 16px 40px;
    }
    .app{ width:min(420px, 100%); }

    /* Topbar (quiet) */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:14px;
    }
    .topbar .brand{
      flex:1;
      text-align:center;
      font-size:12px;
      color: var(--muted);
      letter-spacing:.02em;
      padding:8px 10px;
      border:1px solid rgba(230,232,238,.7);
      border-radius:999px;
      background: rgba(255,255,255,.55);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .iconbtn{
      border:1px solid rgba(230,232,238,.8);
      background: rgba(255,255,255,.7);
      border-radius:14px;
      padding:9px 12px;
      box-shadow: 0 10px 26px rgba(17,24,39,.04);
      cursor:pointer;
      font-weight:800;
      color:#111827;
    }

    /* Screen control */
    .screen{ display:none; }
    .screen.active{ display:block; }

    /* Card */
    .card{
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .inner{ padding: 22px 20px; }

    /* Quiz */
    .progress{
      height:8px;
      border-radius:999px;
      background: var(--bg-soft);
      border:1px solid var(--border);
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(124,58,237,1), rgba(6,182,212,1));
    }
    .metaRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:14px;
    }
    .count{
      font-size:12px;
      color: var(--muted);
      font-weight:800;
      letter-spacing:.02em;
      white-space:nowrap;
    }

    .qTitle{
      font-family: var(--font-serif);
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -.02em;
      margin: 10px 0 6px;
      line-height:1.25;
    }
    .qSub{
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
      margin:0 0 16px;
      line-height:1.5;
    }

    .choices{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .choiceBtn{
      width:100%;
      text-align:left;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 18px;
      padding: 14px 14px;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(17,24,39,.04);
    }
    .choiceMain{
      font-weight: 900;
      letter-spacing:-.01em;
      font-size: 15px;
      margin:0;
    }
    .choiceSub{
      margin-top:6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      line-height:1.5;
    }

    /* Spice choice styling */
    .choiceBtn.spice{
      text-align:center;
      border-style: dashed;
      background: rgba(124,58,237,.03);
    }
    .choiceBtn.spice .choiceMain{
      font-family: var(--font-serif);
      font-size: 17px;
      color: var(--accent);
    }

    .bottomRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:16px;
    }
    .link{
      font-size:12px;
      color: var(--muted);
      font-weight: 800;
      cursor:pointer;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(230,232,238,.8);
      background: rgba(255,255,255,.6);
      user-select:none;
    }

    /* Result (recipe / prescription) */
    .result-card{
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 26px 20px;
      box-shadow: var(--shadow);
    }
    .r-header{
      text-align:center;
      margin-bottom: 18px;
    }
    .r-icon{
      font-size: 38px;
      margin-bottom: 10px;
    }
    .r-persona{
      font-family: var(--font-serif);
      font-size: 26px;
      font-weight: 900;
      margin:0 0 8px;
      line-height: 1.15;
      letter-spacing: -.02em;
    }
    .r-catch{
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
      margin:0;
      line-height:1.5;
    }

    /* Axes (thin, calm) */
    .axes-box{ margin: 18px 0 18px; }
    .axis-row{
      display:grid;
      grid-template-columns: 3fr 4fr 3fr;
      align-items:center;
      gap:12px;
      margin-bottom: 14px;
      font-size: 12px;
      font-weight: 800;
      color: var(--muted);
    }
    .axis-label-left{ text-align:right; }
    .axis-label-right{ text-align:left; }
    .axis-track{
      height: 4px;
      background: var(--bg-soft);
      border: 1px solid var(--border);
      border-radius: 999px;
      position: relative;
    }
    .axis-thumb{
      position:absolute;
      top:50%;
      transform: translate(-50%, -50%);
      width: 10px;
      height: 10px;
      background: #111827;
      border-radius: 50%;
      box-shadow: 0 8px 18px rgba(17,24,39,.10);
    }

    /* Tonight insight (B: mild â€œohâ€) */
    .insight{
      background: var(--bg-soft);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid var(--border);
      margin-bottom: 16px;
    }
    .insightTitle{
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      letter-spacing:.06em;
      margin:0 0 10px;
      text-transform: uppercase;
    }
    .insightText{
      font-size: 14px;
      line-height: 1.75;
      font-weight: 800;
      margin:0;
      color: #111827;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 12px;
    }
    .chip{
      font-size: 11px;
      font-weight: 900;
      color: #111827;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(230,232,238,.9);
      background: rgba(255,255,255,.65);
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Wine recommend (core) */
    .wine-recommend{
      background: var(--bg-soft);
      border-radius: 16px;
      padding: 18px;
      border: 1px solid var(--border);
    }
    .wine-header{
      display:flex;
      align-items:center;
      gap: 14px;
      margin-bottom: 12px;
    }
    .wine-icon{ font-size: 34px; }
    .wine-name{
      font-family: var(--font-serif);
      font-size: 16px;
      font-weight: 900;
      margin:0 0 4px;
      line-height:1.3;
    }
    .wine-tags{
      font-size: 12px;
      font-weight: 900;
      color: var(--accent);
      margin:0;
    }
    .wine-reason{
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed rgba(230,232,238,.9);
      font-size: 13px;
      line-height: 1.9;
      font-weight: 800;
      color: #111827;
    }

    /* CTA */
    .cta{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 16px;
    }
    .btn-primary, .btn-secondary{
      width:100%;
      border-radius: 16px;
      padding: 12px 14px;
      font-weight: 900;
      cursor:pointer;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: 0 10px 26px rgba(17,24,39,.04);
    }
    .btn-primary{
      border:none;
      color:#fff;
      background: linear-gradient(135deg, rgba(124,58,237,1), rgba(6,182,212,1));
      box-shadow: 0 14px 30px rgba(124,58,237,.16);
    }

    .footer{
      margin-top: 14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
    }
    .tag{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(230,232,238,.8);
      background: rgba(255,255,255,.55);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* tiny appear */
    .fadeIn{ animation: fadeIn .18s ease-out both; }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <button class="iconbtn" id="backBtn" aria-label="back">â†</button>
      <div class="brand">Wine Personaï½œå‡¦æ–¹ç®‹ï¼ˆMockï¼‰</div>
      <button class="iconbtn" id="shareBtn">å…±æœ‰</button>
    </div>

    <!-- QUIZ -->
    <section class="screen active fadeIn" id="quizScreen" aria-label="quiz">
      <div class="card">
        <div class="inner">
          <div class="metaRow">
            <div class="count" id="qCount">1 / 6</div>
            <div class="progress" aria-label="progress"><div class="bar" id="progressBar"></div></div>
          </div>

          <div class="qTitle" id="qTitle">ä»Šå¤œã®éã”ã—æ–¹ã¯ï¼Ÿ</div>
          <div class="qSub" id="qSub">ãƒ‘ãƒƒã¨ç›´æ„Ÿã§é¸ã‚“ã§OKã€‚</div>

          <div class="choices" id="choices"></div>

          <div class="bottomRow">
            <div class="link" id="skipBtn">ã‚¹ã‚­ãƒƒãƒ—</div>
            <div class="link" id="finishBtn" style="display:none;">çµæœã‚’è¦‹ã‚‹</div>
          </div>

          <div class="footer">
            <div class="tag">#ä»Šå¤œã®ãƒ¯ã‚¤ãƒ³äººæ ¼</div>
            <div class="tag">Akinator Ã— Recipe</div>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULT -->
    <section class="screen fadeIn" id="resultScreen" aria-label="result">
      <div class="result-card">
        <div class="r-header">
          <div class="r-icon" id="rIcon">ğŸŒ™</div>
          <h1 class="r-persona" id="rPersona">å¤œæ›´ã‹ã—ã®æ¢æ¤œå®¶</h1>
          <p class="r-catch" id="rCatch">ã²ã¨ã‚Šã®å¤œã«ã€æœªçŸ¥ã‚’ä¸€å£ã€‚</p>
        </div>

        <div class="axes-box">
          <div class="axis-row">
            <div class="axis-label-left">ç¤¾äº¤</div>
            <div class="axis-track"><div class="axis-thumb" id="axis-social"></div></div>
            <div class="axis-label-right">å†…çœ</div>
          </div>
          <div class="axis-row">
            <div class="axis-label-left">å®‰å®š</div>
            <div class="axis-track"><div class="axis-thumb" id="axis-adventure"></div></div>
            <div class="axis-label-right">å†’é™º</div>
          </div>
          <div class="axis-row">
            <div class="axis-label-left">è»½å¿«</div>
            <div class="axis-track"><div class="axis-thumb" id="axis-light"></div></div>
            <div class="axis-label-right">æ¿ƒåš</div>
          </div>
          <div class="axis-row">
            <div class="axis-label-left">é£Ÿä¸­</div>
            <div class="axis-track"><div class="axis-thumb" id="axis-food"></div></div>
            <div class="axis-label-right">ä¸»å½¹</div>
          </div>
        </div>

        <!-- B: â€œãŠãŠâ€ã‚’ä½œã‚‹ï¼ˆè»½ãåˆºã•ã‚‹ï¼‰ -->
        <div class="insight">
          <div class="insightTitle">Tonight Insight</div>
          <p class="insightText" id="insightText">
            é™ã‹ã«éã”ã—ãŸã„ã€‚ã§ã‚‚ã€ã„ã¤ã‚‚é€šã‚Šã˜ã‚ƒç‰©è¶³ã‚Šãªã„ã€‚<br/>
            ã ã‹ã‚‰ã€Œè»½ã‚„ã‹ã€ã ã‘ã©ã€Œä½™éŸ»ã€ãŒæ®‹ã‚‹æ–¹å‘ã¸ã€‚
          </p>
          <div class="chips" id="chips"></div>
        </div>

        <!-- C: â€œæ¬¡ã«é£²ã‚€ä¸€æœ¬â€ -->
        <div class="wine-recommend">
          <div class="wine-header">
            <div class="wine-icon">ğŸ·</div>
            <div>
              <p class="wine-name" id="wName">ãƒŸã‚¹ãƒ†ãƒªãƒ¼ãƒ»ãƒ”ãƒ 2022</p>
              <p class="wine-tags" id="wTags">èµ¤ / è»½ã‚„ã‹ / ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼</p>
            </div>
          </div>
          <div class="wine-reason" id="wReason"></div>
        </div>

        <div class="cta">
          <button class="btn-primary" id="btnKeep">ã“ã®ä¸€æœ¬ã‚’ã‚­ãƒ¼ãƒ—ã™ã‚‹</button>
          <button class="btn-secondary" id="btnAlt">åˆ¥ã®ä¸€æœ¬</button>
          <button class="btn-secondary" id="btnRetry">ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹</button>
        </div>

        <div class="footer">
          <div class="tag" id="rareTag">RARE 12%</div>
          <div class="tag">affiliate-ready</div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ====== State (keep original structure) ======
    const state = { social: 50, adventure: 50, light: 50, food: 50 };
    const answers = []; // {chip, tags, qIndex}
    let currentQ = 0;
    let pickIndex = 0;
    let emotionSpice = null; // æœ€å¾Œã®ã²ã¨ã•ã˜

    const clamp = (x,a=0,b=100)=>Math.max(a,Math.min(b,x));
    const dist2 = (a,b)=> (a.social-b.social)**2+(a.adventure-b.adventure)**2+(a.light-b.light)**2+(a.food-b.food)**2;

    function applyDelta(delta){
      for(const k of Object.keys(delta)) state[k]=clamp(state[k]+delta[k]);
    }

    function calcRarePercent(s){
      const bias = Math.abs(s.social-50)+Math.abs(s.adventure-50)+Math.abs(s.light-50)+Math.abs(s.food-50);
      return Math.round(clamp(50 - bias/4, 5, 50));
    }

    // ====== Questions (Akinator feel + spice last) ======
    const questions = [
      {
        title: "ä»Šå¤œã®éã”ã—æ–¹ã¯ï¼Ÿ",
        sub: "ãƒ‘ãƒƒã¨ç›´æ„Ÿã§é¸ã‚“ã§OKã€‚",
        choices: [
          { main:"ã²ã¨ã‚Šã§é™ã‹ã«", sub:"è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§å‘³ã‚ã„ãŸã„", chip:"ğŸ•¯ ã²ã¨ã‚Šã§é™ã‹ã«", tags:["ã²ã¨ã‚Š","é™å¯‚"], delta:{ social:+18 } },
          { main:"èª°ã‹ã¨æ¥½ã—ã", sub:"ä¼šè©±ã‚’ã‚¹ãƒ‘ã‚¤ã‚¹ã«ã—ãŸã„", chip:"ğŸ‘¥ èª°ã‹ã¨æ¥½ã—ã", tags:["èª°ã‹ã¨","è³‘ã‚„ã‹"], delta:{ social:-18 } }
        ]
      },
      {
        title: "ä»Šæ—¥ã¯ã©ã‚“ãªæ°—åˆ†ï¼Ÿ",
        sub: "ã„ã¤ã‚‚ã®è‡ªåˆ†ï¼Ÿãã‚Œã¨ã‚‚â€¦",
        choices: [
          { main:"æ–°ã—ã„å‘³ã«å‡ºä¼šã„ãŸã„", sub:"å°ã•ãªé©šããŒæ¬²ã—ã„", chip:"ğŸ§ª æ–°ã—ã„ã®è©¦ã—ãŸã„", tags:["æœªçŸ¥","å†’é™º"], delta:{ adventure:-18 } },
          { main:"çµ¶å¯¾ã«å¤–ã—ãŸããªã„", sub:"å®‰å¿ƒã§ãã‚‹å¿ƒåœ°ã‚ˆã•", chip:"ğŸ  å¤–ã—ãŸããªã„", tags:["å®‰å¿ƒ","ç‹é“"], delta:{ adventure:+18 } }
        ]
      },
      {
        title: "ä½“ãŒæ±‚ã‚ã¦ã„ã‚‹ã®ã¯ï¼Ÿ",
        sub: "ã‚°ãƒ©ã‚¹ã«æ³¨ãŒã‚Œã‚‹é‡ã•ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã¦ã€‚",
        choices: [
          { main:"ãµã‚ã£ã¨è»½ã‚„ã‹", sub:"ã•ã‚‰ã‚Šã¨å–‰ã‚’æ½¤ã—ãŸã„", chip:"ğŸ«§ è»½ã‚„ã‹", tags:["è»½ã‚„ã‹","ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥"], delta:{ light:-18 } },
          { main:"ã©ã£ã—ã‚Šæº€è¶³", sub:"æ·±ã„ä½™éŸ»ã«æµ¸ã‚ŠãŸã„", chip:"ğŸªµ ã©ã£ã—ã‚Š", tags:["é‡åš","æ·±ã„ä½™éŸ»"], delta:{ light:+18 } }
        ]
      },
      {
        title: "é£Ÿäº‹ã¯ï¼Ÿ",
        sub: "ä»Šå¤œã®ä¸»å½¹ã¯ã©ã£ã¡ï¼Ÿ",
        choices: [
          { main:"æ–™ç†ãŒä¸»å½¹", sub:"ãƒ¯ã‚¤ãƒ³ã¯ä¼´èµ°è€…", chip:"ğŸ½ é£Ÿä¸­", tags:["é£Ÿä¸­","åˆã‚ã›ãŸã„"], delta:{ food:-18 } },
          { main:"ãƒ¯ã‚¤ãƒ³ãŒä¸»å½¹", sub:"ä»Šæ—¥ã®ã‚»ãƒ³ã‚¿ãƒ¼ã¯ã“ã‚Œ", chip:"â­ ä¸»å½¹", tags:["ä¸»å½¹","ã”è¤’ç¾"], delta:{ food:+18 } }
        ]
      },
      {
        title: "æ°—åˆ†ã®æ¸©åº¦ã¯ï¼Ÿ",
        sub: "ãªã‚“ã¨ãªãã§OKã€‚",
        choices: [
          { main:"æ˜ã‚‹ã„", sub:"è»½å¿«ã«å¯„ã›ãŸã„", chip:"ğŸ¥‚ æ˜ã‚‹ã„", tags:["æ˜ã‚‹ã„","è»½å¿«"], delta:{ light:-10, social:-10 } },
          { main:"é™ã‹", sub:"å†…çœã«å¯„ã›ãŸã„", chip:"ğŸ•¯ é™ã‹", tags:["é™ã‹","å†…çœ"], delta:{ light:+10, social:+10 } }
        ]
      },
      // spice (special)
      {
        title: "æœ€å¾Œã«ã€éš ã—å‘³ã‚’ã€‚",
        sub: "ä»Šã®æ°—åˆ†ã«ã€ã²ã¨ã•ã˜åŠ ãˆã‚‹ãªã‚‰ï¼Ÿ",
        isSpice:true,
        choices: [
          { main:"åˆ‡ãªã•", flavor:"ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼ãªæ¨½é¦™", desc:"å°‘ã—ã®ã»ã‚è‹¦ã•ãŒã€æ·±ã¿ã‚’ä¸ãˆã¾ã™" },
          { main:"ãŸã£ã·ã‚Šã®æ„›æƒ…", flavor:"è¯ã‚„ã‹ãªæœå®Ÿå‘³", desc:"æ˜ã‚‹ãç”˜ã‚„ã‹ãªä½™éŸ»ãŒåºƒãŒã‚Šã¾ã™" },
          { main:"æ¾„ã‚“ã é™å¯‚", flavor:"ã‚­ãƒªãƒƒã¨ã—ãŸãƒŸãƒãƒ©ãƒ«æ„Ÿ", desc:"é€æ˜æ„Ÿã®ã‚ã‚‹ä½™éŸ»ã§æ•´ã„ã¾ã™" }
        ]
      }
    ];

    // ====== Personas ======
    const personas = [
      { name:"å¤œæ›´ã‹ã—ã®æ¢æ¤œå®¶", icon:"ğŸŒ™", catch:"ã²ã¨ã‚Šã®å¤œã«ã€æœªçŸ¥ã‚’ä¸€å£ã€‚", vec:{ social:78, adventure:22, light:35, food:68 } },
      { name:"ç‹é“ã®ä¸»å½¹", icon:"ğŸ‘‘", catch:"å¤–ã•ãªã„ã€ã§ã‚‚ã¡ã‚ƒã‚“ã¨ç¾å‘³ã„ã€‚", vec:{ social:30, adventure:75, light:70, food:80 } },
      { name:"è»½å¿«ãªãƒ ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚«ãƒ¼", icon:"ğŸ¥‚", catch:"ã‚·ãƒ¥ãƒ¯ã£ã¨ã€æ˜ã‚‹ãã€‚", vec:{ social:25, adventure:55, light:20, food:55 } }
    ];

    // ====== Picks (REAL from /api/wines) ======
    let picks = [];  // å¾Œã§åŸ‹ã‚ã‚‹
    let picksLoaded = false;

    function styleToJP(style){
        if(style==="red") return "èµ¤";
        if(style==="white") return "ç™½";
        if(style==="sparkling") return "ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒªãƒ³ã‚°";
        if(style==="rose") return "ãƒ­ã‚¼";
        return "ãƒ¯ã‚¤ãƒ³";
    }

    function fmtYen(n){
        if(typeof n !== "number") return "";
        return `${n.toLocaleString("ja-JP")}å††`;
    }

    async function loadPicks(){
        try{
        const res = await fetch("/api/wines?limit=60");
        const json = await res.json();
        const items = json.items || [];

        // HTMLå´ã® picks å½¢å¼ã«å¯„ã›ã‚‹
        picks = items.map(w => ({
            id: w.id,
            name: w.name, // APIå´ã§ã™ã§ã«cleanã•ã‚Œã¦ã„ã‚Œã°ãã®ã¾ã¾
            tags: `${styleToJP(w.style)}${w.price_yen ? " / " + fmtYen(w.price_yen) : ""}${(w.tags && w.tags.length) ? " / " + w.tags.slice(0,2).join(" / ") : ""}`,
            url: w.url,
            review_average: w.review_average,
            review_count: w.review_count,
            // vibeã¯å¾Œã§å­¦ç¿’ã•ã›ã‚‹ã®ã§ä»®ï¼ˆä»Šã¯è¦‹ãŸç›®ã ã‘ã§OKï¼‰
            vibe: { social:50, adventure:50, light:50, food:50 }
        }));

        picksLoaded = true;

        }catch(e){
        console.warn("failed to load picks", e);
        picksLoaded = false;
        }
    }

    function pickPersona(){
      let best = personas[0], bestD = Infinity;
      for(const p of personas){
        const d = dist2(state, p.vec);
        if(d<bestD){ bestD=d; best=p; }
      }
      return best;
    }

    // ====== B Insight ======
    function summarizeInsight(){
      const tags = [...new Set(answers.flatMap(a=>a.tags||[]))];
      const hasQuiet = tags.includes("é™å¯‚") || tags.includes("é™ã‹") || state.social>=60;
      const hasUnknown = tags.includes("æœªçŸ¥") || tags.includes("å†’é™º") || state.adventure<=40;
      const hasSafe = tags.includes("å®‰å¿ƒ") || tags.includes("ç‹é“") || state.adventure>=60;
      const wantsLight = state.light<=40;
      const wantsRich = state.light>=60;

      const line1 = hasQuiet ? "é™ã‹ã«éã”ã—ãŸã„å¤œã€‚" : "èª°ã‹ã¨éã”ã—ãŸã„å¤œã€‚";
      let line2 = "æ¥µç«¯ã˜ã‚ƒãªãã¦ã„ã„ã€‚ä»Šæ—¥ã¯â€œã»ã©ã‚ˆãæ°—åˆ†ãŒä¸ŠãŒã‚‹â€ãŒåˆã†ã€‚";
      if(hasUnknown && hasSafe) line2 = "å®‰å¿ƒã‚‚æ¬²ã—ã„ã®ã«ã€å°‘ã—ã ã‘æœªçŸ¥ã‚‚æ¬²ã—ã„ã€‚ã‚ãŒã¾ã¾ãŒã¡ã‚‡ã†ã©ã„ã„ã€‚";
      else if(hasUnknown) line2 = "ã„ã¤ã‚‚é€šã‚Šã˜ã‚ƒç‰©è¶³ã‚Šãªã„ã€‚å°ã•ãªå†’é™ºã‚’å…¥ã‚ŒãŸã„ã€‚";
      else if(hasSafe) line2 = "å¤–ã—ãŸããªã„ã€‚ä»Šæ—¥ã¯â€œå®‰å¿ƒã§æ°—åˆ†ã‚’ä¸Šã’ã‚‹â€ãŒæ­£è§£ã€‚";

      return `${line1} ã§ã‚‚ã€${line2}<br/>ã ã‹ã‚‰ã€Œ${wantsLight?"è»½ã‚„ã‹":wantsRich?"ã©ã£ã—ã‚Š":"ãƒãƒ©ãƒ³ã‚¹"}ã€å¯„ã‚Šã§ã€‚`;
    }

    // ====== âœ… Short & Strong Reason (final tweak) ======
    function buildReason(pick){
      const tags = answers.flatMap(a=>a.tags||[]);
      const uniq = [...new Set(tags)];

      const t1 = uniq[uniq.length-2] || uniq[0] || "ä»Šå¤œ";
      const t2 = uniq[uniq.length-1] || uniq[1] || "æ°—åˆ†";

      const spice = emotionSpice?.main || "æ¾„ã‚“ã é™å¯‚";
      const flavor = emotionSpice?.flavor || "ã‚­ãƒªãƒƒã¨ã—ãŸãƒŸãƒãƒ©ãƒ«æ„Ÿ";

      return `
        <b>çµè«–ï¼š</b>ã€Œ${t1}ã€Ã—ã€Œ${t2}ã€ã«ã€<b>ã€Œ${spice}ã€ã‚’ä¸€åŒ™</b>ã€‚<br/>
        <b>ã ã‹ã‚‰ï¼š</b>${flavor}ãŒç«‹ã¤æ–¹å‘ã¸ã€‚<br/>
        <b>æ¬¡ã®å¤œï¼š</b>è¿·ã‚ãšã“ã‚Œã‚’è¿ãˆã¦ã»ã—ã„ã€‚
      `;
    }

    function setAxisThumb(id, value){
      document.getElementById(id).style.left = clamp(value) + "%";
    }

    function renderChips(){
      const chipsEl = document.getElementById("chips");
      chipsEl.innerHTML = "";
      const seen = new Set();
      for(let i=answers.length-1; i>=0 && seen.size<3; i--){
        const c = answers[i]?.chip;
        if(!c || c.includes("ã‚¹ã‚­ãƒƒãƒ—")) continue;
        if(seen.has(c)) continue;
        seen.add(c);
      }
      [...seen].reverse().forEach(c=>{
        const span = document.createElement("span");
        span.className = "chip";
        span.textContent = c;
        chipsEl.appendChild(span);
      });
    }

    function renderResult(){
      const persona = pickPersona();
      document.getElementById("rIcon").textContent = persona.icon;
      document.getElementById("rPersona").textContent = persona.name;
      document.getElementById("rCatch").textContent = persona.catch;

      setAxisThumb("axis-social", state.social);
      setAxisThumb("axis-adventure", 100 - state.adventure); // left=å®‰å®š, right=å†’é™º
      setAxisThumb("axis-light", state.light);
      setAxisThumb("axis-food", state.food);

      document.getElementById("insightText").innerHTML = summarizeInsight();
      renderChips();

      if(!picksLoaded || !picks.length){
        document.getElementById("wName").textContent = "ï¼ˆèª­ã¿è¾¼ã¿ä¸­â€¦ï¼‰";
        document.getElementById("wTags").textContent = "å°‘ã—å¾…ã£ã¦ã­";
        document.getElementById("wReason").innerHTML = "ãƒ¯ã‚¤ãƒ³å€™è£œã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚";
        return;
        }
      const pick = picks[pickIndex % picks.length];
      document.getElementById("wName").textContent = pick.name;
      document.getElementById("wTags").textContent = pick.tags;
      document.getElementById("wReason").innerHTML = buildReason(pick);

      document.getElementById("rareTag").textContent = `RARE ${calcRarePercent(state)}%`;
    }

    // ====== Screens ======
    const quizScreen = document.getElementById("quizScreen");
    const resultScreen = document.getElementById("resultScreen");

    function show(screen){
      [quizScreen, resultScreen].forEach(s=>s.classList.remove("active"));
      screen.classList.add("active");
      screen.classList.remove("fadeIn"); void screen.offsetWidth; screen.classList.add("fadeIn");
    }

    // ====== Render question ======
    function renderQuestion(){
      const q = questions[currentQ];
      document.getElementById("qTitle").textContent = q.title;
      document.getElementById("qSub").textContent = q.sub;

      document.getElementById("qCount").textContent = `${currentQ+1} / ${questions.length}`;
      document.getElementById("progressBar").style.width = `${Math.round((currentQ)/(questions.length)*100)}%`;

      const choicesEl = document.getElementById("choices");
      choicesEl.innerHTML = "";

      q.choices.forEach((c)=>{
        const btn = document.createElement("button");
        btn.className = "choiceBtn" + (q.isSpice ? " spice" : "");
        btn.innerHTML = `
          <div class="choiceMain">${c.main}</div>
          <div class="choiceSub">${q.isSpice ? (c.desc || "") : (c.sub || "")}</div>
        `;
        btn.addEventListener("click", ()=>{
          if(q.isSpice){
            emotionSpice = c; // {main, flavor, desc}
          }else{
            applyDelta(c.delta || {});
            answers.push({ qIndex: currentQ, chip: c.chip, tags: c.tags });
          }
          next();
        });
        choicesEl.appendChild(btn);
      });

      document.getElementById("finishBtn").style.display = (currentQ === questions.length-1) ? "inline-flex" : "none";
    }

    function next(){
      if(currentQ < questions.length-1){
        currentQ++;
        renderQuestion();
      }else{
        if(!emotionSpice){
          emotionSpice = questions.find(x=>x.isSpice)?.choices?.[2] || { main:"æ¾„ã‚“ã é™å¯‚", flavor:"ã‚­ãƒªãƒƒã¨ã—ãŸãƒŸãƒãƒ©ãƒ«æ„Ÿ" };
        }
        renderResult();
        show(resultScreen);
      }
    }

    function skip(){
      answers.push({ qIndex: currentQ, chip:"â­ ã‚¹ã‚­ãƒƒãƒ—", tags:["ã»ã©ã‚ˆã"] });
      state.social = Math.round((state.social + 50)/2);
      state.adventure = Math.round((state.adventure + 50)/2);
      state.light = Math.round((state.light + 50)/2);
      state.food = Math.round((state.food + 50)/2);
      next();
    }

    function reset(){
      state.social=50; state.adventure=50; state.light=50; state.food=50;
      answers.length=0;
      currentQ=0;
      pickIndex=0;
      emotionSpice=null;
      renderQuestion();
      show(quizScreen);
    }

    // ====== Events ======
    document.getElementById("skipBtn").addEventListener("click", skip);
    document.getElementById("finishBtn").addEventListener("click", next);

    // Back: mock safety -> resultãªã‚‰æœ€åˆã‹ã‚‰
    document.getElementById("backBtn").addEventListener("click", ()=>{
      if(resultScreen.classList.contains("active")) reset();
      else if(currentQ>0){ currentQ--; renderQuestion(); }
    });

    document.getElementById("btnAlt").addEventListener("click", ()=>{
      pickIndex++;
      renderResult();
    });

    document.getElementById("btnKeep").addEventListener("click", ()=>{
    const pick = picks[pickIndex % picks.length];
    if(pick?.url) window.open(pick.url, "_blank");
    else alert("ãƒªãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
    });

    document.getElementById("btnRetry").addEventListener("click", reset);

    document.getElementById("shareBtn").addEventListener("click", async ()=>{
      const persona = document.getElementById("rPersona").textContent.trim();
      const wine = document.getElementById("wName").textContent.trim();
      const spice = emotionSpice?.main || "æ¾„ã‚“ã é™å¯‚";
      const text = `Wine Personaï½œå‡¦æ–¹ç®‹\nã€çµæœã€‘${persona}\nã€éš ã—å‘³ã€‘${spice}\nã€æ¬¡ã®ä¸€æœ¬ã€‘${wine}\n#ä»Šå¤œã®ãƒ¯ã‚¤ãƒ³äººæ ¼`;
      try{
        if(navigator.share) await navigator.share({ text });
        else { await navigator.clipboard.writeText(text); alert("å…±æœ‰ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }
      }catch(e){}
    });

    // init
    (async ()=>{
    await loadPicks();
    renderQuestion();
    })();
  </script>
</body>
</html>